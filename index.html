<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>RENEX Login</title>
</head>
<body>

  <h1>RENEX Login</h1>

  <input id="handle" value="demo" />
  <button id="loginBtn">Login mit Passkey</button>

<script type="module">
import { loginWithPasskey } from "./js/auth.js";
import { apiFetch } from "./js/api.js";

// =========================================
// üîê SICHERER AUTO-LOGIN CHECK
// =========================================
async function checkExistingSession() {
  const token = localStorage.getItem("session_token");
  if (!token) return;

  try {
    // Backend entscheidet
    await apiFetch("/users/me");

    // ‚úÖ Session g√ºltig ‚Üí Inbox
    window.location.replace("./inbox.html");
  } catch (e) {
    // ‚ùå Session ung√ºltig / abgelaufen
    console.warn("Session ung√ºltig ‚Äì Login erforderlich");

    localStorage.removeItem("session_token");
    localStorage.removeItem("user_handle");
  }
}

// üî• SOFORT BEIM LADEN AUSF√úHREN
checkExistingSession();

// =========================================
// üîê LOGIN BUTTON
// =========================================
document.getElementById("loginBtn").onclick = async () => {
  const handle =
    document.getElementById("handle").value.trim() || "demo";

  try {
    await loginWithPasskey(handle);

    // üîé nach Login pr√ºfen
    await apiFetch("/users/me");

    window.location.replace("./inbox.html");
  } catch (e) {
    alert("‚ùå Login fehlgeschlagen");
  }
};
</script>

</body>
</html>
